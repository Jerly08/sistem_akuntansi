package main

import (
	"fmt"
	"log"

	"app-sistem-akuntansi/config"
	"app-sistem-akuntansi/models"

	"gorm.io/gorm"
)

func main() {
	// Initialize database
	db, err := config.InitDB()
	if err != nil {
		log.Fatal("Failed to connect to database:", err)
	}

	fmt.Println("=== DEBUGGING JOURNAL ENTRIES FOR SALES ===")

	// Get all journal entries related to sales
	var journalEntries []models.JournalEntry
	err = db.Preload("JournalLines").Where("reference LIKE ?", "SALE%").Find(&journalEntries).Error
	if err != nil {
		log.Fatal("Failed to fetch journal entries:", err)
	}

	fmt.Printf("Found %d journal entries related to sales:\n\n", len(journalEntries))

	for _, entry := range journalEntries {
		fmt.Printf("üìã Journal Entry ID: %d\n", entry.ID)
		fmt.Printf("   Reference: %s\n", entry.Reference)
		fmt.Printf("   Description: %s\n", entry.Description)
		fmt.Printf("   Total Amount: %.2f\n", entry.TotalAmount)
		fmt.Printf("   Date: %s\n", entry.TransactionDate.Format("2006-01-02"))
		fmt.Println("   Journal Lines:")
		
		totalDebit := 0.0
		totalCredit := 0.0
		
		for _, line := range entry.JournalLines {
			fmt.Printf("     - Account: %s, Debit: %.2f, Credit: %.2f\n", 
				line.AccountCode, line.Debit, line.Credit)
			totalDebit += line.Debit
			totalCredit += line.Credit
		}
		
		fmt.Printf("   Total Debit: %.2f, Total Credit: %.2f\n", totalDebit, totalCredit)
		if totalDebit != totalCredit {
			fmt.Printf("   ‚ùå WARNING: Debit != Credit (Difference: %.2f)\n", totalDebit-totalCredit)
		} else {
			fmt.Printf("   ‚úÖ Balanced entry\n")
		}
		fmt.Println("   " + "="*50)
		fmt.Println()
	}

	// Check account balances for key accounts
	fmt.Println("=== CURRENT ACCOUNT BALANCES ===")
	keyAccounts := []string{"1201", "4101", "5101", "1301"}
	
	for _, accountCode := range keyAccounts {
		var account models.Account
		err = db.Where("code = ?", accountCode).First(&account).Error
		if err != nil {
			fmt.Printf("‚ùå Account %s not found: %v\n", accountCode, err)
			continue
		}
		
		fmt.Printf("üè¶ Account %s (%s): %.2f\n", account.Code, account.Name, account.Balance)
	}

	// Check sales data
	fmt.Println("\n=== SALES DATA ===")
	var sales []models.Sale
	err = db.Preload("SaleItems").Where("status IN ?", []string{"confirmed", "invoiced"}).Find(&sales).Error
	if err != nil {
		log.Fatal("Failed to fetch sales:", err)
	}

	fmt.Printf("Found %d confirmed/invoiced sales:\n", len(sales))
	totalSalesAmount := 0.0
	
	for _, sale := range sales {
		fmt.Printf("üì¶ Sale ID: %d, Code: %s, Status: %s\n", sale.ID, sale.Code, sale.Status)
		fmt.Printf("   Total: %.2f, Customer: %s\n", sale.TotalAmount, sale.CustomerName)
		fmt.Printf("   Date: %s\n", sale.Date.Format("2006-01-02"))
		totalSalesAmount += sale.TotalAmount
		
		fmt.Println("   Items:")
		for _, item := range sale.SaleItems {
			fmt.Printf("     - %s: Qty %d √ó %.2f = %.2f\n", 
				item.ProductName, item.Quantity, item.UnitPrice, item.TotalPrice)
		}
		fmt.Println()
	}
	
	fmt.Printf("üìä Total Sales Amount: %.2f\n", totalSalesAmount)
	fmt.Printf("üìä Account 4101 Balance: Should match this amount if all entries are correct\n")
}
