<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Debug - SSOT Balance Monitor</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #1e1e1e;
            color: #ffffff;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            background: #2d2d2d;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        input, button, select {
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 4px;
            background: #3d3d3d;
            color: white;
            font-family: inherit;
        }
        button {
            background: #0078d4;
            cursor: pointer;
            border: none;
        }
        button:hover {
            background: #106ebe;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.connected {
            background: #1a5a1a;
            border: 1px solid #4caf50;
            color: #4caf50;
        }
        .status.connecting {
            background: #5a5a1a;
            border: 1px solid #ff9800;
            color: #ff9800;
        }
        .status.disconnected {
            background: #5a1a1a;
            border: 1px solid #f44336;
            color: #f44336;
        }
        .status.error {
            background: #5a1a1a;
            border: 1px solid #f44336;
            color: #f44336;
        }
        .log {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        .log-info { color: #00bcd4; }
        .log-success { color: #4caf50; }
        .log-warning { color: #ff9800; }
        .log-error { color: #f44336; }
        .log-debug { color: #9e9e9e; }
        h1 {
            color: #00bcd4;
            border-bottom: 2px solid #00bcd4;
            padding-bottom: 10px;
        }
        h2 {
            color: #ff9800;
            margin-top: 30px;
        }
        .token-display {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
            color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç WebSocket Balance Monitor Debug Tool</h1>
        
        <div class="section">
            <h2>üìä Authentication Status</h2>
            <div class="controls">
                <button id="checkAuth">Check Auth Status</button>
                <button id="loginBtn">Quick Login</button>
                <input type="email" id="email" placeholder="Email" value="admin@company.com">
                <input type="password" id="password" placeholder="Password" value="password123">
            </div>
            <div id="authStatus" class="status disconnected">Not Authenticated</div>
            <div id="tokenDisplay" class="token-display" style="display: none;"></div>
        </div>

        <div class="section">
            <h2>üîå WebSocket Connection Test</h2>
            <div class="controls">
                <select id="endpoint">
                    <option value="ws://localhost:8080/ws/balance">ws://localhost:8080/ws/balance</option>
                    <option value="ws://localhost:8080/api/v1/journals/account-balances/ws">ws://localhost:8080/api/v1/journals/account-balances/ws</option>
                </select>
                <button id="connectBtn">Connect</button>
                <button id="disconnectBtn" disabled>Disconnect</button>
                <button id="clearLog">Clear Log</button>
            </div>
            <div id="wsStatus" class="status disconnected">Disconnected</div>
        </div>

        <div class="section">
            <h2>üìù Connection Log</h2>
            <div id="logOutput" class="log"></div>
        </div>

        <div class="section">
            <h2>üìà Real-time Messages</h2>
            <div>Messages Received: <span id="messageCount">0</span></div>
            <div>Last Update: <span id="lastUpdate">Never</span></div>
            <div>Connection Duration: <span id="duration">0s</span></div>
        </div>
    </div>

    <script>
        let ws = null;
        let token = null;
        let connectionStartTime = null;
        let messageCount = 0;
        let durationTimer = null;

        const logOutput = document.getElementById('logOutput');
        const authStatus = document.getElementById('authStatus');
        const wsStatus = document.getElementById('wsStatus');
        const tokenDisplay = document.getElementById('tokenDisplay');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(`[WebSocket Debug] ${message}`);
        }

        function updateAuthStatus(isAuth, tokenValue = null) {
            token = tokenValue;
            if (isAuth && token) {
                authStatus.className = 'status connected';
                authStatus.textContent = 'Authenticated ‚úì';
                tokenDisplay.textContent = `Token: ${token.substring(0, 50)}...`;
                tokenDisplay.style.display = 'block';
                log('Authentication successful', 'success');
            } else {
                authStatus.className = 'status disconnected';
                authStatus.textContent = 'Not Authenticated ‚úó';
                tokenDisplay.style.display = 'none';
                log('Not authenticated', 'warning');
            }
        }

        function updateConnectionStatus(status, message = '') {
            wsStatus.className = `status ${status}`;
            switch(status) {
                case 'connected':
                    wsStatus.textContent = `Connected ‚úì ${message}`;
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    break;
                case 'connecting':
                    wsStatus.textContent = `Connecting... ${message}`;
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = true;
                    break;
                case 'disconnected':
                    wsStatus.textContent = `Disconnected ‚úó ${message}`;
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    break;
                case 'error':
                    wsStatus.textContent = `Error ‚ö† ${message}`;
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    break;
            }
        }

        function startDurationTimer() {
            connectionStartTime = Date.now();
            durationTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - connectionStartTime) / 1000);
                document.getElementById('duration').textContent = `${elapsed}s`;
            }, 1000);
        }

        function stopDurationTimer() {
            if (durationTimer) {
                clearInterval(durationTimer);
                durationTimer = null;
            }
        }

        // Check current authentication status
        document.getElementById('checkAuth').onclick = () => {
            const storedToken = localStorage.getItem('token');
            const storedUser = localStorage.getItem('user');
            
            log('Checking stored authentication...', 'info');
            log(`Stored token: ${storedToken ? 'Found (' + storedToken.length + ' chars)' : 'Not found'}`, 'debug');
            log(`Stored user: ${storedUser ? 'Found' : 'Not found'}`, 'debug');

            if (storedToken && storedUser) {
                try {
                    const user = JSON.parse(storedUser);
                    log(`User: ${user.email} (${user.role})`, 'info');
                    updateAuthStatus(true, storedToken);
                } catch (e) {
                    log('Error parsing stored user data', 'error');
                    updateAuthStatus(false);
                }
            } else {
                updateAuthStatus(false);
            }
        };

        // Quick login
        document.getElementById('loginBtn').onclick = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                log('Please enter email and password', 'error');
                return;
            }

            log('Attempting login...', 'info');
            
            try {
                const response = await fetch('http://localhost:8080/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    const accessToken = data.access_token || data.token;
                    
                    // Store in localStorage (like the frontend does)
                    localStorage.setItem('token', accessToken);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    log(`Login successful for ${data.user.email}`, 'success');
                    updateAuthStatus(true, accessToken);
                } else {
                    const error = await response.json();
                    log(`Login failed: ${error.message || response.statusText}`, 'error');
                    updateAuthStatus(false);
                }
            } catch (e) {
                log(`Login error: ${e.message}`, 'error');
                updateAuthStatus(false);
            }
        };

        // WebSocket connection
        document.getElementById('connectBtn').onclick = () => {
            if (!token) {
                log('No authentication token available. Please login first.', 'error');
                return;
            }

            const endpoint = document.getElementById('endpoint').value;
            log(`Attempting to connect to: ${endpoint}`, 'info');
            
            updateConnectionStatus('connecting', '');
            messageCount = 0;
            document.getElementById('messageCount').textContent = '0';

            // Construct WebSocket URL based on endpoint
            let wsUrl;
            if (endpoint.includes('ws/balance')) {
                wsUrl = `${endpoint}?token=${encodeURIComponent(token)}`;
            } else {
                wsUrl = endpoint;
            }

            log(`WebSocket URL: ${wsUrl}`, 'debug');

            try {
                ws = new WebSocket(wsUrl);

                // Set headers for endpoints that support it
                if (!endpoint.includes('ws/balance')) {
                    // For /api/v1/journals/account-balances/ws, we need to send auth in headers
                    // But native WebSocket doesn't support custom headers easily
                    // This might be the issue!
                    log('WARNING: This endpoint may require custom headers which browser WebSocket cannot send', 'warning');
                }

                ws.onopen = (event) => {
                    log('WebSocket connection opened', 'success');
                    updateConnectionStatus('connected', '');
                    startDurationTimer();
                };

                ws.onmessage = (event) => {
                    messageCount++;
                    document.getElementById('messageCount').textContent = messageCount;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();

                    try {
                        const data = JSON.parse(event.data);
                        log(`üì® Received: ${data.type} - ${JSON.stringify(data)}`, 'success');
                    } catch (e) {
                        log(`üì® Received (raw): ${event.data}`, 'info');
                    }
                };

                ws.onclose = (event) => {
                    log(`WebSocket closed: Code ${event.code} - ${event.reason || 'No reason'}`, 'warning');
                    updateConnectionStatus('disconnected', `(${event.code})`);
                    stopDurationTimer();
                };

                ws.onerror = (event) => {
                    log(`WebSocket error: ${event.message || 'Unknown error'}`, 'error');
                    updateConnectionStatus('error', '');
                    stopDurationTimer();
                };

            } catch (e) {
                log(`Connection error: ${e.message}`, 'error');
                updateConnectionStatus('error', e.message);
            }
        };

        document.getElementById('disconnectBtn').onclick = () => {
            if (ws) {
                log('Manually closing WebSocket connection...', 'info');
                ws.close(1000, 'Manual disconnect');
                ws = null;
            }
        };

        document.getElementById('clearLog').onclick = () => {
            logOutput.innerHTML = '';
        };

        // Initialize
        log('WebSocket Debug Tool initialized', 'info');
        log('Click "Check Auth Status" to see current authentication state', 'info');
    </script>
</body>
</html>